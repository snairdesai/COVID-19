### Import library
```{r}
#getwd()
library(lubridate)
library(zoo)
library(quantmod)
library(fBasics)
library(tseries)
library(sandwich)
library(lmtest)
library(lattice)
library(xtable)
library(vars)
library(plyr)
library(gridExtra)
library(corrplot)
library(ggplot2)
library(reshape2)
library(data.table)
library(rvest)
library(foreign)
library(dplyr)
library(plm)
library(stringr)
library(stargazer)
library(survival)
library(ggfortify)
library(plotly)
library(sf)
library(readr)
library(mapview)
library(ggplot2)
library(tidyverse)
# library(rlang)
library(reshape)
library(rgdal)
library(lubridate)
library(plotly)
library(patchwork)
library(ggforce)
library(gridExtra)
library(htmltools)
library(data.table)
library(webshot)
library(coronavirus)
library(runner)
library(zoo)
library(DataCombine)
library(fastDummies)
library(car)
library(heatmaply)
library(htmlwidgets)
library(summarytools)
library(glmnet)
library(caret)
library(mlbench)
library(psych)
library(plm)
library(lmtest)
library(quantmod)
library(leaflet)
library(corrplot)
library(fBasics)
library(stargazer)
library(tseries)
library(vars)
library(dplyr)

```

### Read Final_Data_Country
```{r}
dat<-read.csv("./Data/Final_Data_Country.csv",header=T,sep=',')
# Remove factor variables for government responses and lagged variables
dat<-dat %>% select(-contains("Flag"))
dat<-dat %>% select(-contains("Lagged"))
dat$latitude <- NULL
dat$longitude <- NULL
```

### Merge global preference survey data to Final_Data_Country
```{r}
gps.country <- read.dta("./Data/GPS_dataset_country_level/country_v11.dta")
# Change country names for merge
gps.country[which(gps.country$country == "South Korea"),"country"] <- "Korea, South"
gps.country[which(gps.country$country == "Czech Republic"),"country"] <- "Czechia"
gps.country[which(gps.country$country == "United States"),"country"] <- "US"

gps.individual <- read.dta("./Data/GPS_dataset_individual_level/individual_v11_new.dta")
# Change country names for merge
gps.individual[which(gps.individual$country == "South Korea"),"country"] <- "Korea, South"
gps.individual[which(gps.individual$country == "Czech Republic"),"country"] <- "Czechia"
gps.individual[which(gps.individual$country == "United States"),"country"] <- "US"

gps.individual$age <- as.character(gps.individual$age)
gps.individual[which(gps.individual$age == "99 99+"), "age"] <- "99"
gps.individual[which(gps.individual$age == "100 (Refused"), "age"] <- NA
gps.individual$age <- as.numeric(gps.individual$age)
gps.individual.pop65 <- gps.individual[which(!is.na(gps.individual$age) & gps.individual$age > 65), ]
gps.individual.pop65 <- gps.individual.pop65[which(!is.na(gps.individual.pop65$trust)),]
gps.country.pop65 <- ddply(gps.individual.pop65, "country", function(X) data.frame(wm.trust = weighted.mean(X$trust, X$wgt)))

colnames(gps.country)[1] <- "COUNTRY"
dat <- merge(dat, gps.country, by=c("COUNTRY"), all.x=TRUE)
colnames(gps.country.pop65)[1] <- "COUNTRY"
dat <- merge(dat, gps.country.pop65, by=c("COUNTRY"), all.x=TRUE)
```

### Rename variables and create some new variables
```{r}
a<-pdata.frame(dat, index = c("COUNTRY", "Date"))
a$Date<-as.Date(a$Date,"%Y-%m-%d")
#reorder
a<-a[order(a$Date),]
a<-a[order(a$COUNTRY),]

colnames(a)[colnames(a) == "Total_Cases_Country"] <- "Total_Case_Country"
colnames(a)[colnames(a) == "Total_Deceased_Country"] <- "Total_Death_Country"
colnames(a)[colnames(a) == "New_Confirmed_Country"] <- "New_Case_Country"
colnames(a)[colnames(a) == "New_Total_Deceased_Country"] <- "New_Death_Country"
colnames(a)[colnames(a) == "Total_Mortality_Rate_Per_Capita"] <- "Total_Mortality_Rate"
colnames(a)[colnames(a) == "New_Mortality_Rate_Per_Capita"] <- "New_Mortality_Rate"
colnames(a)[colnames(a) == "Total_Cases_Country_Per_Capita"] <- "Total_Case_Rate"
colnames(a)[colnames(a) == "rolling_average_confirmed"] <- "RollingAverage_New_Case_Country"
colnames(a)[colnames(a) == "rolling_average_deceased"] <- "RollingAverage_New_Death_Country"
colnames(a)[colnames(a) == "total_rolling_average_mortality"] <- "RollingAverage_Total_Mortality_Rate"
colnames(a)[colnames(a) == "new_rolling_average_mortality"] <- "RollingAverage_New_Mortality_Rate"
colnames(a)[colnames(a) == "EUI_democracy"] <- "EIU_Democracy"
a$RollingAverage_Total_Mortality_Rate <- NULL
a$longitude <- NULL
a$latitude <- NULL

a$New_Case_Rate = a$New_Case_Country/a$Population

a <- a %>%
  group_by(COUNTRY) %>%
  mutate(RollingAverage_New_Case_Rate = frollmean(New_Case_Rate, 7,na.rm=TRUE))

a <- a %>%
  group_by(COUNTRY) %>%
  mutate(Total_Mortality_Rate_Growth = log(Total_Mortality_Rate) - Lag(log(Total_Mortality_Rate),7))

a <- a %>%
  group_by(COUNTRY) %>%
  mutate(Total_Case_Rate_Growth = log(Total_Case_Rate) - Lag(log(Total_Case_Rate),7))

a <- a %>%
  group_by(COUNTRY) %>%
  mutate(New_Case_Rate_Growth = log(RollingAverage_New_Case_Rate) - Lag(log(RollingAverage_New_Case_Rate),7))

a <- a %>%
  group_by(COUNTRY) %>%
  mutate(New_Mortality_Rate_Growth = log(RollingAverage_New_Mortality_Rate) - Lag(log(RollingAverage_New_Mortality_Rate),7))

a$respiratory_deaths_rate <- 1/3*(a$respiratory_deaths/a$Population)
```

### Reorder columns
```{r}
a <- a %>%
 select(c("COUNTRY", "X", "Date",
          "Total_Case_Country", "Total_Death_Country", "New_Case_Country", "New_Death_Country", "Population",
          "Total_Case_Rate", "Total_Mortality_Rate", "New_Case_Rate", "New_Mortality_Rate", 
          "RollingAverage_New_Case_Country", "RollingAverage_New_Death_Country", 
          "RollingAverage_New_Case_Rate", "RollingAverage_New_Mortality_Rate", 
          "Total_Case_Rate_Growth", "Total_Mortality_Rate_Growth", 
          "New_Case_Rate_Growth", "New_Mortality_Rate_Growth"), everything())

a$Total_Case_Rate_Growth[is.nan(a$Total_Case_Rate_Growth)] <- NA
a$Total_Mortality_Rate_Growth[is.nan(a$Total_Mortality_Rate_Growth)] <- NA

a$New_Case_Rate_Growth[is.nan(a$New_Case_Rate_Growth)] <- NA
a$New_Mortality_Rate_Growth[is.nan(a$New_Mortality_Rate_Growth)] <- NA

a$New_Mortality_Rate_Growth[is.infinite(-a$New_Mortality_Rate_Growth)] <- Inf

colnames(a)
```

### Generate key endogenous variables used in cross-country analysis
```{r}
country <- c("")

# Mortality
date.first.death <- c(0)
date.peak.mortality <- c(0)
days.to.peak.mortality <- c(0)
peak.or.no.mortality <- c(0)
peak.cum.mortality <- c(0)
peak.new.mortality <- c(0)
early.mortality <- c(0)
early.mortality.growth<-c(0)

# Case
date.first.case <- c(0)
date.peak.case <- c(0)
days.to.peak.case <- c(0)
peak.or.no.case <- c(0)
peak.cum.case <- c(0)
peak.new.case <- c(0)
early.case <- c(0)
early.case.growth <- c(0)

# Stringency Index
early.stringency.sum <- c(0)
peak.stringency <- c(0)
first.stringency <- c(0)
date.first.stringency <- c(0)
date.peak.stringency <- c(0)
early.stringency.average <- c(0)


# Mobility
early.mobility.walking<-c(0)

dems_data<-aggregate(data=a,cbind(prop65,propurban,popdensity,vul_emp,health_exp,GNI,pollution,Latitude,Longitude,EIU_Democracy)~COUNTRY,FUN=mean,na.rm=T)

for(i in 1:length(unique(dems_data$COUNTRY))){
  
  b<-subset(a,COUNTRY==unique(dems_data$COUNTRY)[i])
  country[i] <- as.character(unique(dems_data$COUNTRY)[i])
  b<-b[order(b$Date),]
  b<-b[order(b$COUNTRY),]
  b <- b %>%
    group_by(COUNTRY) %>%
    mutate(RollingAverage_Walking = frollmean(walking, 7))
  b <- b %>%
    group_by(COUNTRY) %>%
    mutate(RollingAverage_StringencyIndex = frollmean(StringencyIndex, 7))
  
  # Mortality
  date.first.death[i]<-as.character(b$Date[which(b$Total_Death_Country>0)[1]]) # Date of first death
  peak.new.mortality[i]<-max(b$RollingAverage_New_Mortality_Rate,na.rm = TRUE) # Peak new mortality
  date.peak.mortality[i]<-as.character(b$Date[which((b$RollingAverage_New_Mortality_Rate==peak.new.mortality[i]))]) # Date of peak new mortality
  days.to.peak.mortality[i]<-as.Date(date.peak.mortality[i])-as.Date(date.first.death[i]) # Days from first death to peak new mortality
  peak.cum.mortality[i]<-b$Total_Mortality_Rate[which(b$RollingAverage_New_Mortality_Rate==peak.new.mortality[i])] # Total mortality rate at the peak
  peak.or.no.mortality[i]<-ifelse(date.peak.mortality[i]==max(b$Date)-1,0,1)
  early.mortality[i]<-b$Total_Mortality_Rate[which(b$Total_Death_Country>0)[7]] # Total mortality in the first week since first death
  early.mortality.growth[i]<-log(b$RollingAverage_New_Mortality_Rate[which(b$Total_Death_Country>0)[7]]) -
    log(b$RollingAverage_New_Mortality_Rate[which(b$Total_Death_Country>0)[1]])# Growth rate of new mortality rate in the first week since first death
  
  # Case
  date.first.case[i]<-as.character(b$Date[which(b$Total_Case_Country>0)[1]]) # Date of first case
  peak.new.case[i]<-max(b$RollingAverage_New_Case_Rate, na.rm = TRUE) # Peak new case
  date.peak.case[i]<-as.character(b$Date[which((b$RollingAverage_New_Case_Rate==peak.new.case[i]))]) # Date of peak new case
  days.to.peak.case[i]<-as.Date(date.peak.case[i])-as.Date(date.first.case[i]) # Days from first case to peak new case
  peak.cum.case[i]<-b$Total_Case_Rate[which.max(b$RollingAverage_New_Case_Rate==peak.new.case[i])] # Toal case rate at the peak
  peak.or.no.case[i]<-ifelse(date.peak.case[i]==max(b$Date),0,1)
  early.case[i]<-b$Total_Case_Rate[which(b$Total_Case_Country>0)[7]] # Total case rate in the first week since first case
  if (b$RollingAverage_New_Case_Rate[which(b$Total_Case_Country>0)[1]] == 0){
    early.case.growth[i]<-log(b$RollingAverage_New_Case_Rate[which(b$Total_Case_Country>0)[7]]) -  log(b$Total_Case_Rate[which(b$Total_Case_Country>0)[1]])# Growth rate of new case rate in the first week since first case
  }else{
    early.case.growth[i]<-log(b$RollingAverage_New_Case_Rate[which(b$Total_Case_Country>0)[7]]) -  log(b$RollingAverage_New_Case_Rate[which(b$Total_Case_Country>0)[1]])# Growth rate of new case rate in the first week since first case
  }
  
  # Stringency Index
  early.stringency.sum[i] <- sum(b$StringencyIndex[which(b$Date<date.first.death[i] & !is.na(b$StringencyIndex))])  # Sum of stringency index prior to first death
  early.stringency.average[i] <- mean(b$StringencyIndex[which(b$Date<date.first.death[i] & !is.na(b$StringencyIndex))])  # Average of stringency index prior to first death
  # early.stringency[i]<-b$RollingAverage_StringencyIndex[which(b$Total_Death_Country>0)[1]-7] #Weekly average stringency index in the week prior to first death
  # early.stringency[i]<-b$StringencyIndex[which(b$Total_Death_Country>0)[1]-10] #Weekly average stringency index in the week prior to first death
  
  first.stringency[i] <- b$StringencyIndex[which(b$StringencyIndex > 0)[1]] # First SI, no matter before or after the first case
  # first.stringency[i] <- b$StringencyIndex[which(b$C1_School.closing > 0 | b$C2_Workplace.closing > 0 |
  #                                                b$C3_Cancel.public.events > 0 | b$C4_Restrictions.on.gatherings > 0 |
  #                                                b$C5_Close.public.transport > 0 | b$C6_Stay.at.home.requirements > 0 | 
  #                                                b$C7_Restrictions.on.internal.movement > 0)[1]] # First SI, no matter before or after the first case or death
  peak.stringency[i] <- max(b$StringencyIndex,na.rm=T) # Peak SI
  
  date.first.stringency[i] <- as.character(b$Date[which(b$StringencyIndex > 0)[1]]) # Date of first SI
  # date.first.stringency[i] <- as.character(b$Date[which(b$C1_School.closing > 0 | b$C2_Workplace.closing > 0 |
  #                                                b$C3_Cancel.public.events > 0 | b$C4_Restrictions.on.gatherings > 0 |
  #                                                b$C5_Close.public.transport > 0 | b$C6_Stay.at.home.requirements > 0 | 
  #                                                b$C7_Restrictions.on.internal.movement > 0)[1]]) # Date of first SI
  if (peak.stringency[i] == -Inf){
    date.peak.stringency[i] <- -Inf
  }else{
    date.peak.stringency[i] <- as.character(b$Date[which.max(b$StringencyIndex)])
  }
  
  # Mobility
  early.mobility.walking[i]<-b$RollingAverage_Walking[which(b$Total_Death_Country>0)[1]-1] # Weekly average walking mobility in the week prior to first death
  
}

stringency.delta <- (peak.stringency-first.stringency)/as.numeric(as.Date(date.peak.stringency)-as.Date(date.first.stringency))
log.early.stringency.sum <- log(early.stringency.sum)
log.early.stringency.sum[which(is.infinite(-log.early.stringency.sum))] <- NA
how.early.stringency <- as.numeric(as.Date(date.first.death)-as.Date(date.first.stringency))
# early.stringency.average <- early.stringency/how.early.stringency
log.peak.mortality.to.duration <- log(peak.new.mortality)/as.numeric(days.to.peak.mortality)
log.peak.case.to.duration <- log(peak.new.case)/as.numeric(days.to.peak.case)

# set NA early stringency to 0
# early.string[is.na(early.string)]<-0

```

### Set up cross-section data
```{r}
surv.dat<-data.frame(country,days.to.peak.mortality,peak.or.no.mortality,
                     days.to.peak.case,peak.or.no.case,
                     early.mortality,early.mortality.growth,
                     early.case,early.case.growth,
                     peak.cum.mortality,peak.cum.case,peak.new.mortality,peak.new.case,
                     log.peak.mortality.to.duration,log.peak.case.to.duration,
                     early.stringency.average,early.stringency.sum,log.early.stringency.sum,how.early.stringency,stringency.delta,peak.stringency,
                     early.mobility.walking,dems_data[,-1])
surv.dat$south <- 0
surv.dat$south[which(surv.dat$country == "Brazil"|surv.dat$country == "Peru"|surv.dat$country == "Chile"|surv.dat$country == "Argentina"|surv.dat$country == "South Africa"|surv.dat$country == "Australia"|surv.dat$country == "New Zealand")] <- 1
#remove vietnam
surv.dat<-surv.dat[-nrow(surv.dat),]
surv.dat<-mutate(surv.dat,stringent=ifelse(early.stringency.average>7.77,"SI>7.77","SI<7.77"),stringent=factor(stringent))
```

### Cross-country analysis on the peak mortality
```{r}
### - peak new mortality - 
cs.new.mortality <- lm(log(peak.new.mortality) ~ 
                       log(early.mortality)+early.mortality.growth+
                       early.stringency.average+how.early.stringency+
                       stringency.delta+early.mobility.walking+
                       prop65+propurban+popdensity+vul_emp+log(GNI)+EIU_Democracy+Latitude:Longitude,data=surv.dat,na.action = "na.exclude")
se.new.mortality<-coeftest(cs.new.mortality, vcov = vcovHC(cs.new.mortality, type = "HC1"))

surv.dat$res.new.mortality = resid(cs.new.mortality)

### - peak new mortality to duration ratio - 
cs.peak.duration.ratio<- lm(log.peak.mortality.to.duration ~ 
                                  log(early.mortality)+early.mortality.growth+
                                  early.stringency.average+how.early.stringency+
                                  stringency.delta+early.mobility.walking+
                                  prop65+propurban+popdensity+vul_emp+log(GNI)+EIU_Democracy+Latitude:Longitude,data=surv.dat,na.action = "na.exclude")
se.peak.duration.ratio<-coeftest(cs.peak.duration.ratio, vcov = vcovHC(cs.peak.duration.ratio, type = "HC1"))

surv.dat$res.peak.duration.ratio = resid(cs.peak.duration.ratio)

### - survival analysis on pandemic duration to first peak
cox.death<-coxph(Surv(days.to.peak.mortality,peak.or.no.mortality) ~
                   log(peak.new.mortality)+log(early.mortality)+early.mortality.growth+
                   early.stringency.average+how.early.stringency+
                   stringency.delta+early.mobility.walking+
                   prop65+propurban+popdensity+vul_emp+log(GNI)+EIU_Democracy+Latitude:Longitude,data=surv.dat)

test.death<-cox.zph(cox.death)$table[nrow(cox.zph(cox.death)$table),ncol(cox.zph(cox.death)$table)]

```

### HTML output of the cross-country analysis
```{r,warning=FALSE, results='hide',message=FALSE}
stargazer(cs.new.mortality,cs.peak.duration.ratio,cox.death,
          se=list(se.new.mortality[,2],se.peak.duration.ratio[,2]),type="html",out=file.path("Outputs_revision","Table_cs_reg_output_avgSI.htm"),intercept.bottom = FALSE,
          dep.var.labels=c("Log(Peak New Mortality Rate)","Log(Peak New Moratlity Rate)-to-PD Ratio","Survival Probability of Mortality Peaking at Time (t)"),
          covariate.labels=c("Intercept","Log(Peak Mortality)","Log(Early Mortality)","Early Mortality Growth",
                             "Early SI","Days between First SI and First Death",
                             "Stringency Delta","Early Mobility",
                             "Prop. 65+","Prop. Urban","Pop. Density","Vulnerable Emp.", "Log(GNI)",
                             "EIU Democracy","Latitude:Longitude"), 
          df = FALSE,omit.stat =c("max.rsq","logrank"),
          notes = c("*,**,*** correspond to 10%, 5% and 1% significance, respectively.",
                    "PH Test refers to testing the proportional hazards assumption (Grambsch and Therneau (1994)).",
                    "Null hypothesis is the assumption is not violated.",
                    "Standard errors in linear models are Heteroscedastic-Robust standard errors."),
          notes.append=F,notes.align ="l",font.size = "tiny",
          title=("Cross-Country Regression: Explaining Differences in the Empirical Shape of First-Wave Mortality Rates"),
          add.lines = list(c("PH Test p-value",NA,NA,round(test.death,3))),
          table.layout = "-ldm#-t=sa-n")
```

### Plot K-M curves for mortality
```{r}
km_fit <- survfit(Surv(days.to.peak.mortality,peak.or.no.mortality) ~1, data=surv.dat)

p1<-autoplot(km_fit)+theme_bw()+xlab("Number of Days")+ylab("Probability that Mortality Peak is Yet to Come")
km_fit2<-survfit(Surv(days.to.peak.mortality,peak.or.no.mortality)~stringent, data=surv.dat)
p2<-autoplot(km_fit2)+theme_bw()+xlab("Number of Days")+ylab("Probability that Mortality Peak is Yet to Come")+theme(legend.position = c(0.2, 0.2),legend.title=element_blank())
p3<-ggplot(data=surv.dat,aes(x=early.stringency.average,fill=stringent))+geom_histogram(color="black",alpha=.5)+theme_bw()+xlab("Average SI from the First Non-Zero SI to the First Death")+ylab("Frequency of Countries")+theme(legend.title = element_blank(),legend.position = c(0.7,0.6))
g <- grid.arrange(p1, p2, p3, nrow=1)
# g <- arrangeGrob(p1,p2,p3,nrow=1)
ggsave(path = "Outputs_revision", filename = "Figure_KM_mortaity.png", g, width = 15, height = 7)

```

### Correlation matrix of explanatory variables
```{r}
cor.surv.dat <- surv.dat[,c("days.to.peak.mortality","early.mortality","early.mortality.growth",
                            "peak.new.mortality","log.peak.mortality.to.duration",
                            "early.stringency.average","how.early.stringency","stringency.delta",
                            "early.mobility.walking",
                            "prop65","propurban","popdensity","vul_emp","health_exp","GNI","pollution","Latitude","Longitude","EIU_Democracy")]

colnames(cor.surv.dat)<-c("PD to Peak Mortality", "Early Mortality", "Early Mortality Growth",
                     "Peak New Mortality", "Logged Peak Mortality-to-PD",
                     "Early SI","Days from First SI to First Death", "Stringency Delta",
                     "Early Mobility",
                     "Prop. 65+", "Prop. Urban", "Pop. Density", 
                     "Vulnerable Emp.","Health Exp.","GNI","Pollution","Latitude","Longitude","Democracy")
cormat<-round(cor(cor.surv.dat,use = "complete.obs"), 2)

# Here, I get the lower triangle of the correlation matrix
get_lower_tri<-function(cormat){
  cormat[upper.tri(cormat)] <- NA
  return(cormat)
}
# Now, I get the upper triangle of the correlation matrix
get_upper_tri <- function(cormat){
  cormat[lower.tri(cormat)]<- NA
  return(cormat)
}
reorder_cormat <- function(cormat){
# Use correlation between variables as distance
dd <- as.dist((1-cormat)/2)
hc <- hclust(dd)
cormat <-cormat[hc$order, hc$order]
}
cormat <- reorder_cormat(cormat)
melted_cormat <- reshape2::melt(get_upper_tri(cormat), na.rm = TRUE)

### Generate the Static Correlation Map
ggheatmap <- ggplot(data = melted_cormat, aes(x=Var2, y=Var1, fill=value)) + 
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white",
    midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45)) +
  theme(axis.text.x = element_text(margin = margin(t = 5, r = 0, b = 0, l = 0))) +
  theme(axis.text.x = element_text(hjust=1))+coord_fixed()

p.cor <- ggheatmap + 
geom_text(aes(Var2, Var1, label = value), color = "black", size = 1.75) +
theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  axis.text=element_text(size=7),
  panel.grid.major = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank(),
  axis.ticks = element_blank(),
  legend.justification = c(1, 0),
  legend.position = c(0.4, 0.8),
  legend.direction = "horizontal",
  legend.title = element_text(size = 6),
  legend.text=element_text(size=6))+
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                title.position = "top", title.hjust = 0.5))

# Print the heatmap
print(p.cor)
ggsave(file.path("Outputs_revision","Figure_corrmat_covariate.png"),p.cor,width=8, height=8)

```

### Correlation matrix of government interventions
```{r}

cor.policy.dat <- a[,c("C1_School.closing", 
                      "C2_Workplace.closing",
                      "C3_Cancel.public.events",
                      "C4_Restrictions.on.gatherings",
                      "C5_Close.public.transport",            
                      "C6_Stay.at.home.requirements",         
                      "C7_Restrictions.on.internal.movement", 
                      "C8_International.travel.controls",
                      "H1_Public.information.campaigns",
                      "StringencyIndex")]
colnames(cor.policy.dat) <- c("School Closing", 
                      "Workplace Closing",
                      "Cancel Public Events",
                      "Gathering Restrictions",
                      "Close Public Transport",            
                      "Stay at Home",         
                      "Internal Movement Restrictions", 
                      "International Travel Controls",
                      "Public Information Campaigns",
                      "Stringency Index")
cormat<-round(cor(cor.policy.dat,use = "complete.obs"), 2)

# Here, I get the lower triangle of the correlation matrix
get_lower_tri<-function(cormat){
  cormat[upper.tri(cormat)] <- NA
  return(cormat)
}
# Now, I get the upper triangle of the correlation matrix
get_upper_tri <- function(cormat){
  cormat[lower.tri(cormat)]<- NA
  return(cormat)
}
reorder_cormat <- function(cormat){
# Use correlation between variables as distance
dd <- as.dist((1-cormat)/2)
hc <- hclust(dd)
cormat <-cormat[hc$order, hc$order]
}
cormat <- reorder_cormat(cormat)
melted_cormat <- reshape2::melt(get_upper_tri(cormat), na.rm = TRUE)

### Generate the Static Correlation Map
ggheatmap <- ggplot(data = melted_cormat, aes(x=Var2, y=Var1, fill=value)) + 
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white",
    midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45)) +
  theme(axis.text.x = element_text(margin = margin(t = 5, r = 0, b = 0, l = 0))) +
  theme(axis.text.x = element_text(hjust=1))+coord_fixed()

p.cor <- ggheatmap + 
geom_text(aes(Var2, Var1, label = value), color = "black", size = 1.75) +
theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  axis.text=element_text(size=7),
  panel.grid.major = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank(),
  axis.ticks = element_blank(),
  legend.justification = c(1, 0),
  legend.position = c(0.6, 0.7),
  legend.direction = "horizontal",
  legend.title = element_text(size = 7),
  legend.text=element_text(size=7),
  plot.caption = element_text(size = 7, hjust=0))+
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                title.position = "top", title.hjust = 0.5))

# Print the heatmap
print(p.cor)
ggsave(file.path("Outputs_revision","Figure_corrmat_policy.png"),p.cor,width=5, height=5)

```


### Summary statistics of country characteristics
```{r}
cor.sum.dat <- surv.dat[,c("days.to.peak.mortality","early.mortality","early.mortality.growth",
                            "peak.new.mortality","log.peak.mortality.to.duration",
                            "early.stringency.average","how.early.stringency","stringency.delta",
                            "early.mobility.walking",
                            "prop65","propurban","popdensity","vul_emp","health_exp","GNI","pollution","Latitude","Longitude","EIU_Democracy")]
cor.sum.dat$early.mortality <- cor.sum.dat$early.mortality * 10000000
cor.sum.dat$peak.new.mortality <- cor.sum.dat$peak.new.mortality * 10000000
cor.sum.dat$GNI <- log(cor.sum.dat$GNI)
colnames(cor.sum.dat)<-c("PD to Peak Mortality", "Early Mortality", "Early Mortality Growth",
                     "Peak New Mortality", 
                     "Logged Peak Mortality-to-PD",
                     "Early SI","Days from First SI to First Death", "Stringency Delta",
                     "Early Mobility",
                     "Prop. 65+", "Prop. Urban", "Pop. Density", 
                     "Vulnerable Employment","Health Expenditure","Log(GNI)","Pollution","Latitude","Longitude","Democracy")
sum.stats <- t(round(basicStats(cor.sum.dat),3))
sum.stats <- data.frame(sum.stats[,c("nobs", "NAs", "Minimum", "Maximum", "1. Quartile", "3. Quartile", "Mean", "Median", "Stdev")])
sum.stats$N <- sum.stats$nobs - sum.stats$NAs
sum.stats <- sum.stats[,-c(1,2)]
sum.stats <- sum.stats %>%
  select(c("N", "Minimum", "Maximum", "Mean", "Median", "Stdev"), everything())
colnames(sum.stats) <- c("N", "Minimum", "Maximum", "Mean", "Median", "S.D.", "25 Percentile", "75 Percentile")
peak.stringency.finite <- cor.sum.dat$`Peak Stringency`[which(is.finite(cor.sum.dat$`Peak Stringency`))]
stargazer(sum.stats,type="html",summary = FALSE, out=file.path("Outputs_revision","Table_summary_country_char.htm"),title="Country Characteristics: Summary")
```

### Table of variable definitions and sources
```{r}

df.definition <- data.frame("Variable" = c("New Mortality Rate",
                                           "Early Mortality", "Early Mortality Growth","Peak New Mortality",
                                           "PD to Peak Mortality", "Logged Peak Mortality-to-PD",
                                           "Early SI", "Days from First SI to First Death", "Stringency Delta", 
                                           "Early Mobility",
                                           "Prop. 65+", "Prop. Urban", "Pop. Density", 
                                           "Vulnerable Employment","Health Expenditure","GNI","Pollution",
                                           "Tourist Arrivals", "Tourist Departures",
                                           "Latitude","Longitude","Democracy"),
                            "Definition" = c("7-day rolling average of daily new mortality rate out ot the total population",
                                             "Cumulative mortality rate in the week following the first death",
                                             "Growth rate of new mortality rate in the week following the first death",
                                             "New mortality rate at the peak of new mortality rate in the first quasi-bell curve",
                                             "Day-to-peak of new mortality rate in the first quasi-bell curve",
                                             "The ratio of the logged peak new mortality rate to the PD to peak mortality",
                                             "Average of SI from its first non-zero value to the first death",
                                             "Number of days from first non-zero SI to the first death",
                                             "Growth rate of SI from its first non-zero value to its maximum level",
                                             "Weekly average level of mobility in terms of walking in the week prior to the first death, reported by Apple",
                                             "Elderly population (people aged 65 and over) as a percentage of the total population",
                                             "Urban population as a percentage of the total population",
                                             "Midyear population divided by land area in square kilometers",
                                             "Employment in vulnerable sectors (i.e., family workers and own-account workers) as a percentage of the total employment",
                                             "Level of current health expenditure (including healthcare goods and services) as a percentage of GDP",
                                             "Gross national income per capita",
                                             "Population-weighted exposure to ambient PM2.5 pollution",
                                             "International inbound tourists to the country",
                                             "International outbound tourists from the country",
                                             "Latitude coordinate of the country",
                                             "Longitude coordinate of the country",
                                             "The Democracy index calculated by The Economist Intelligence Unit"
                                             ),
                            "Source" = c("Authors' calculation based on JHU COVID-19 Data",
                                         "Authors' calculation based on JHU COVID-19 Data",
                                         "Authors' calculation based on JHU COVID-19 Data",
                                         "Authors' calculation based on JHU COVID-19 Data",
                                         "Authors' calculation based on JHU COVID-19 Data",
                                         "Authors' calculation based on JHU COVID-19 Data",
                                         "Authors' calculation based on OxCGRT Data",
                                         "Authors' calculation based on OxCGRT Data",
                                         "Authors' calculation based on OxCGRT Data",
                                         "Authors' calculation based on Apple COVID-19 Mobility Trends Reports",
                                         "World Development Indicators",
                                         "World Development Indicators",
                                         "World Development Indicators",
                                         "World Development Indicators",
                                         "World Development Indicators",
                                         "World Development Indicators",
                                         "World Development Indicators",
                                         "World Development Indicators",
                                         "World Development Indicators",
                                         "Country-level coordinates from Google",
                                         "Country-level coordinates from Google",
                                         "The EIU Democracy Index 2019 Database"
                                         )
                              )
rownames(df.definition) <- NULL
stargazer(df.definition,type="html",rownames = FALSE, summary = FALSE, out=file.path("Outputs_revision","Table_variable_definition.htm"))
```

### Visualization of mortality curves, normalized by the first death
```{r}
a <- a %>%
  group_by(COUNTRY) %>%
  mutate(First_Date_Mortality = as.character(Date[which(Total_Death_Country>0)[1]]))
a$Days_Since_First_Death <- as.Date(as.character(a$Date))-as.Date(as.character(a$First_Date_Mortality))
a_normalized <- a[which(a$First_Date_Mortality>-1),]
Plot_normalized <- plot_ly(a_normalized, x=~Days_Since_First_Death, y=~RollingAverage_New_Mortality_Rate) %>%
  add_lines(linetype = ~COUNTRY) %>%
  layout(xaxis = list(range = c(0, 50)))
Plot_normalized
```

### Visualization of mortality curves, normalized by the first death
```{r}
a <- a %>%
  group_by(COUNTRY) %>%
  mutate(First_Date_Mortality = as.character(Date[which(Total_Death_Country>0)[1]]))
a$Days_Since_First_Death <- as.Date(as.character(a$Date))-as.Date(as.character(a$First_Date_Mortality))
a_normalized <- a[which(a$First_Date_Mortality>-1),]
Plot_date <- plot_ly(a, x=~Date, y=~RollingAverage_New_Mortality_Rate) %>%
  add_lines(linetype = ~COUNTRY)
Plot_date
```

### Outcome variables 
```{r}
a_normalized_v0 <- a_normalized[which(a$COUNTRY == "Czechia"),]

Mortality_curve_v0 <- ggplot(data=a_normalized_v0, aes(x=Days_Since_First_Death, y=RollingAverage_New_Mortality_Rate)) +
  geom_line(color="blue", size = 0.75) + geom_segment(aes(x=23, xend=23, y=0, yend=max(a_normalized_v0$RollingAverage_New_Mortality_Rate[which(!is.na(a_normalized_v0$RollingAverage_New_Mortality_Rate))])), 
        size=1, colour="blue", linetype="dotted") + geom_ribbon(data = a_normalized_v0 %>% filter(Days_Since_First_Death < 24), aes(ymin = 0, ymax = a_normalized_v0$RollingAverage_New_Mortality_Rate[which(a_normalized_v0$Days_Since_First_Death<24)]), fill = "red", alpha = .5) + xlim(0, 50) + labs(x = "Days since the first death", y = "Daily new mortality rate, 7-day rolling average") + theme_bw() + theme(axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10), axis.title = element_text(size = 14))
Mortality_curve_v0
ggsave(path = "Outputs_revision", filename = "Figure_outcome_variable.png", Mortality_curve_v0, width = 12, height = 6)

```

### Same peak, different durations: Norway versus Hungary
```{r}
a_normalized_v1 <- a_normalized[which(a$COUNTRY == "Hungary" | a$COUNTRY == "Norway"),]


Mortality_curve_v1 <- ggplot(data=a_normalized_v1, aes(x=Days_Since_First_Death, y=RollingAverage_New_Mortality_Rate, group=COUNTRY)) +
  geom_line(aes(color=COUNTRY), size = 0.75) + xlim(0, 50) + labs(x = "Days since the first death", y = "Daily new mortality rate, 7-day rolling average") + theme_bw() + theme(legend.position = c(0.2, 0.8), legend.title = element_blank(), legend.text=element_text(size=8))

Mortality_curve_v1

```

### Same duration, different peaks: Norway versus Denmark
```{r}
a_normalized_v2 <- a_normalized[which(a$COUNTRY == "Denmark" | a$COUNTRY == "Norway"),]


Mortality_curve_v2 <- ggplot(data=a_normalized_v2, aes(x=Days_Since_First_Death, y=RollingAverage_New_Mortality_Rate, group=COUNTRY)) +
  geom_line(aes(color=COUNTRY), size = 0.75) + xlim(0, 50) + labs(x = "Days since the first death", y = "Daily new mortality rate, 7-day rolling average") + theme_bw() + theme(legend.position = c(0.2, 0.8), legend.title = element_blank(), legend.text=element_text(size=8))

Mortality_curve_v2

```

### Different durations, different peaks, different ratios: Austria, Czechia versus Estonia
```{r}
a_normalized_v3 <- a_normalized[which(a$COUNTRY == "Austria" | a$COUNTRY == "Estonia" | a$COUNTRY == "Greece"),]


Mortality_curve_v3 <- ggplot(data=a_normalized_v3, aes(x=Days_Since_First_Death, y=RollingAverage_New_Mortality_Rate, group=COUNTRY)) +
  geom_line(aes(color=COUNTRY), size = 0.75) + xlim(0, 50) + labs(x = "Days since the first death", y = "Daily new mortality rate, 7-day rolling average") + theme_bw() + theme(legend.position = c(0.15, 0.85),legend.title = element_blank(), legend.text=element_text(size=8))

Mortality_curve_v3

```

### Arrange mortality curve plots
```{r}
g <- grid.arrange(Mortality_curve_v1, Mortality_curve_v2, Mortality_curve_v3, nrow=1)
ggsave(path = "Outputs_revision", filename = "Figure_mortaity_curve_shapes.png", g, width = 15, height = 5)
```

### Cross-country analysis on the peak mortality
```{r}
### - peak new mortality - 
cs.new.mortality <- lm(log(peak.new.mortality) ~ 
                       log(early.mortality)+early.mortality.growth+
                       early.stringency.average+how.early.stringency+
                       stringency.delta+
                       prop65+propurban+popdensity+vul_emp+log(GNI)+EIU_Democracy+Latitude:Longitude,data=surv.dat,na.action = "na.exclude")
se.new.mortality<-coeftest(cs.new.mortality, vcov = vcovHC(cs.new.mortality, type = "HC1"))

surv.dat$res.new.mortality = resid(cs.new.mortality)

### - peak new mortality to duration ratio - 
cs.peak.duration.ratio<- lm(log.peak.mortality.to.duration ~ 
                                  log(early.mortality)+early.mortality.growth+
                                  early.stringency.average+how.early.stringency+
                                  stringency.delta+
                                  prop65+propurban+popdensity+vul_emp+log(GNI)+EIU_Democracy+Latitude:Longitude,data=surv.dat,na.action = "na.exclude")
se.peak.duration.ratio<-coeftest(cs.peak.duration.ratio, vcov = vcovHC(cs.peak.duration.ratio, type = "HC1"))

surv.dat$res.peak.duration.ratio = resid(cs.peak.duration.ratio)

### - survival analysis on pandemic duration to first peak
cox.death<-coxph(Surv(days.to.peak.mortality,peak.or.no.mortality) ~
                   log(peak.new.mortality)+log(early.mortality)+early.mortality.growth+
                   early.stringency.average+how.early.stringency+
                   stringency.delta+
                   prop65+propurban+popdensity+vul_emp+log(GNI)+EIU_Democracy+Latitude:Longitude,data=surv.dat)

test.death<-cox.zph(cox.death)$table[nrow(cox.zph(cox.death)$table),ncol(cox.zph(cox.death)$table)]
```

### Residual map - peak new mortality
```{r}

require(maps)
require(viridis)
world_map <- map_data("world")
ggplot(world_map, aes(x = long, y = lat, group = group)) +
  geom_polygon(fill="lightgray", colour = "white")
colnames(world_map)[1] <- "Longitude"
colnames(world_map)[2] <- "Latitude"

world_map$region[world_map$region == "Czech Republic"] <- "Czechia"
world_map$region[world_map$region == "USA"] <- "US"
world_map$region[world_map$region == "UK"] <- "United Kingdom"
world_map$region[world_map$region == "South Korea"] <- "Korea, South"

colnames(world_map)[5] <- "country"

surv.dat.map <- left_join(world_map, surv.dat, by = "country")

colnames(surv.dat.map)[1] <- "Longitude"
colnames(surv.dat.map)[2] <- "Latitude"

# Finally, we can construct our initial marker map. First, I set different colors for each quantile.
surv.dat.map$abs.res.new.mortality <- abs(surv.dat.map$res.new.mortality)

p.res.new.mortality <- ggplot(surv.dat.map, aes(x = Longitude, y = Latitude)) +
  geom_polygon(aes(group = group, fill = round(res.new.mortality,2)), color = "white") +
  # geom_text(aes(label = round(cs.total.mortality.res,2)), data = surv.dat, size = 2)+
  # scale_fill_viridis(option="C", begin = min(surv.dat$cs.total.mortality.res[!is.na(surv.dat$cs.total.mortality.res)]), end = max(surv.dat$cs.total.mortality.res[!is.na(surv.dat$cs.total.mortality.res)]))+
  theme_void()+
  labs(fill = "Residuals")+
  theme(legend.text = element_text(size = 7),legend.title=element_text(size=8), legend.position = c(0.95,0.5))+
  scale_fill_gradient(low = "red", high = "blue", na.value = "lightgrey",guide = "colourbar")+
  guides(fill = guide_colourbar(barwidth = 1.1, barheight = 3.3))

p.res.new.mortality 

surv.dat.sorted.new.mortality <- surv.dat[order(-surv.dat$res.new.mortality),]

ggsave(file.path("Outputs_revision","Figure_res_peak_new_mortality.png"), p.res.new.mortality, width=10, height=5)

res.new.mortality.rank <- surv.dat.sorted.new.mortality[!is.na(surv.dat.sorted.new.mortality$res.new.mortality),c("country", "res.new.mortality")]
colnames(res.new.mortality.rank) <- c("Country", "Residual")
rownames(res.new.mortality.rank) <- NULL
under.predicted.new.mortality <- res.new.mortality.rank[c(1:5),]
over.predicted.new.mortality <- res.new.mortality.rank[c(seq(nrow(res.new.mortality.rank),nrow(res.new.mortality.rank)-4,-1)),]
stargazer(under.predicted.new.mortality,type="html",rownames = FALSE, summary = FALSE, out=file.path("Outputs_revision","Table_res_new_mortality_under_predicted.htm"))
stargazer(over.predicted.new.mortality,type="html",rownames = FALSE, summary = FALSE, out=file.path("Outputs_revision","Table_res_new_mortality_over_predicted.htm"))

```

### Residual map - peak new mortality-to-PD ratio
```{r}

require(maps)
require(viridis)
world_map <- map_data("world")
ggplot(world_map, aes(x = long, y = lat, group = group)) +
  geom_polygon(fill="lightgray", colour = "white")
colnames(world_map)[1] <- "Longitude"
colnames(world_map)[2] <- "Latitude"

world_map$region[world_map$region == "Czech Republic"] <- "Czechia"
world_map$region[world_map$region == "USA"] <- "US"
world_map$region[world_map$region == "UK"] <- "United Kingdom"
world_map$region[world_map$region == "South Korea"] <- "Korea, South"

colnames(world_map)[5] <- "country"

surv.dat.map <- left_join(world_map, surv.dat, by = "country")

colnames(surv.dat.map)[1] <- "Longitude"
colnames(surv.dat.map)[2] <- "Latitude"

surv.dat.map$abs.res.peak.duration.ratio <- abs(surv.dat.map$res.peak.duration.ratio)

p.res.peak.duration.ratio <- ggplot(surv.dat.map, aes(x = Longitude, y = Latitude)) +
  geom_polygon(aes(group = group, fill = round(res.peak.duration.ratio,2)), color = "white") +
  # geom_text(aes(label = round(cs.total.mortality.res,2)), data = surv.dat, size = 2)+
  # scale_fill_viridis(option="C", begin = min(surv.dat$cs.total.mortality.res[!is.na(surv.dat$cs.total.mortality.res)]), end = max(surv.dat$cs.total.mortality.res[!is.na(surv.dat$cs.total.mortality.res)]))+
  theme_void()+
  labs(fill = "Residuals")+
  theme(legend.text = element_text(size = 7),legend.title=element_text(size=8), legend.position = c(0.95,0.5))+
  scale_fill_gradient(low = "green", high = "blue", na.value = "lightgrey",guide = "colourbar")+
  guides(fill = guide_colourbar(barwidth = 1.1, barheight = 3.3))

p.res.peak.duration.ratio

surv.dat.sorted.peak.to.PD.ratio <- surv.dat[order(-surv.dat$res.peak.duration.ratio),]

ggsave(file.path("Outputs_revision","Figure_res_peak_duration.ratio.png"), p.res.peak.duration.ratio, width=10, height=5)

res.ratio.rank <- surv.dat.sorted.peak.to.PD.ratio[!is.na(surv.dat.sorted.peak.to.PD.ratio$res.peak.duration.ratio),c("country", "res.peak.duration.ratio")]
colnames(res.ratio.rank) <- c("Country", "Residual")
rownames(res.ratio.rank) <- NULL
under.predicted.ratio <- res.ratio.rank[c(1:5),]
over.predicted.ratio <- res.ratio.rank[c(seq(nrow(res.ratio.rank),nrow(res.ratio.rank)-4,-1)),]
stargazer(under.predicted.ratio,type="html",rownames = FALSE, summary = FALSE, out=file.path("Outputs_revision","Table_res_ratio_under_predicted.htm"))
stargazer(over.predicted.ratio,type="html",rownames = FALSE, summary = FALSE, out=file.path("Outputs_revision","Table_res_ratio_over_predicted.htm"))

```
